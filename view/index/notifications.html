{extend name="index/main-layout" /}

{block name="content"}
<!-- 桌面端内容 -->
<!-- 主内容区 -->
<main class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- 页面标题 -->
    <h1 class="text-2xl font-bold mb-6 flex items-center">
        <i class="fa fa-bell mr-2 text-primary"></i>
        通知中心
    </h1>

    <!-- 标签切换 -->
    <div class="flex gap-2 mb-6 bg-bg-card rounded-lg p-1 shadow-soft">
        <button id="tab-all" class="flex-1 py-2 px-4 rounded-lg bg-lightBlue text-primary font-medium transition-colors" onclick="switchTab('all')">
            <i class="fa fa-bell mr-2"></i>全部通知
        </button>
        <button id="tab-unread" class="flex-1 py-2 px-4 rounded-lg text-text-secondary hover:bg-lightBlue hover:text-primary font-medium transition-colors" onclick="switchTab('unread')">
            <i class="fa fa-envelope mr-2"></i>未读通知
        </button>
    </div>

    <script>
        // 获取当前用户信息
        window.currentUserInfo = <?php echo isset($isLogin) && $isLogin && $currentUser ? json_encode([
            'id' => $currentUser['id'] ?? '',
            'username' => $currentUser['username'] ?? '',
            'nickname' => $currentUser['nickname'] ?? '',
            'avatar' => $currentUser['avatar'] ?? '/static/images/default-avatar.png'
        ]) : 'null'; ?>;

        // 切换标签（PC端）
        function switchTab(tabName) {
            console.log('PC switchTab called with:', tabName);

            // 重置所有标签样式
            document.getElementById('tab-all').classList.remove('bg-lightBlue', 'text-primary');
            document.getElementById('tab-unread').classList.remove('bg-lightBlue', 'text-primary');
            document.getElementById('tab-all').classList.add('text-text-secondary', 'hover:bg-lightBlue', 'hover:text-primary');
            document.getElementById('tab-unread').classList.add('text-text-secondary', 'hover:bg-lightBlue', 'hover:text-primary');

            // 设置选中标签样式
            if (tabName === 'all') {
                document.getElementById('tab-all').classList.remove('text-text-secondary', 'hover:bg-lightBlue', 'hover:text-primary');
                document.getElementById('tab-all').classList.add('bg-lightBlue', 'text-primary');
            } else if (tabName === 'unread') {
                document.getElementById('tab-unread').classList.remove('text-text-secondary', 'hover:bg-lightBlue', 'hover:text-primary');
                document.getElementById('tab-unread').classList.add('bg-lightBlue', 'text-primary');
            }

            // 重新加载通知列表
            loadNotificationsPC(tabName === 'unread');
        }

        // 加载通知列表（PC端）
        async function loadNotificationsPC(unreadOnly = false) {
            console.log('PC loadNotifications called, unreadOnly:', unreadOnly);
            const container = document.getElementById('notifications-content');
            if (!container) return;

            try {
                const response = await fetch('/notifications/getNotifications?unread_only=' + (unreadOnly ? 1 : 0), {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.code === 200) {
                    const notifications = result.data.list;
                    console.log('PC notifications loaded:', notifications);

                    if (notifications.length > 0) {
                        // 渲染通知列表
                        container.innerHTML = '';
                        notifications.forEach(notification => {
                            const notificationElement = createNotificationElementPC(notification);
                            container.appendChild(notificationElement);
                        });
                    } else {
                        container.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fa fa-bell-o text-4xl mb-3"></i>
                                <p>暂无通知</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error(result.msg || '获取通知失败');
                }
            } catch (error) {
                console.error('PC 加载通知失败:', error);
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fa fa-exclamation-circle text-xl mb-2"></i>
                        <p>加载失败，请稍后重试</p>
                    </div>
                `;
            }
        }

        // 显示通知弹窗（PC端）
        function showNotificationPopup(notification) {
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm';

            // 格式化时间
            const time = new Date(notification.create_time);
            const timeText = time.toLocaleString('zh-CN');

            // 设置图标
            const typeConfig = {
                1: { icon: 'fa-heart', color: 'text-red-500', title: '点赞通知' },
                2: { icon: 'fa-comment', color: 'text-purple-500', title: '评论通知' },
                3: { icon: 'fa-user-plus', color: 'text-blue-500', title: '关注通知' },
                4: { icon: 'fa-envelope', color: 'text-green-500', title: '私信通知' },
                5: { icon: 'fa-bell', color: 'text-yellow-500', title: '系统通知' }
            };
            const config = typeConfig[notification.type] || typeConfig[5];

            popup.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <i class="fa ${config.icon} ${config.color} text-2xl mr-2"></i>
                            <h3 class="text-lg font-bold">${config.title}</h3>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="text-gray-600 mb-4">${notification.content}</div>
                    <div class="text-xs text-gray-400 text-right mb-4">${timeText}</div>
                    ${notification.target_id && notification.target_type === 'moment' ? `
                        <a href="/moments/${notification.target_id}" class="block w-full text-center py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            查看动态
                        </a>
                    ` : ''}
                </div>
            `;

            document.body.appendChild(popup);

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        // 更新顶部通知徽章
        async function updateNotificationBadge() {
            try {
                const response = await fetch('/notifications/getBadge', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.code === 200 && result.data) {
                    const count = result.data.count;

                    // 更新PC端通知badge
                    const pcBadge = document.getElementById('pc-notification-badge');
                    if (pcBadge) {
                        if (count > 0) {
                            pcBadge.textContent = count > 99 ? '99+' : count;
                            pcBadge.classList.remove('hidden');
                        } else {
                            pcBadge.classList.add('hidden');
                        }
                    }

                    // 更新移动端顶部通知badge
                    const mobileBadge = document.getElementById('mobile-notification-badge');
                    if (mobileBadge) {
                        if (count > 0) {
                            mobileBadge.textContent = count > 99 ? '99+' : count;
                            mobileBadge.classList.remove('hidden');
                        } else {
                            mobileBadge.classList.add('hidden');
                        }
                    }

                    // 更新移动端底部导航"更多"的通知badge
                    const footerBadge = document.getElementById('footer-notification-badge');
                    if (footerBadge) {
                        if (count > 0) {
                            footerBadge.textContent = count > 99 ? '99+' : count;
                            footerBadge.classList.remove('hidden');
                        } else {
                            footerBadge.classList.add('hidden');
                        }
                    }
                }
            } catch (error) {
                console.error('更新徽章失败:', error);
            }
        }

        // 创建通知元素（PC端）
        function createNotificationElementPC(notification) {
            const div = document.createElement('div');

            // 判断是否已读
            const isUnread = notification.is_read === 0;
            // 已读/未读标识
            const readStatusText = isUnread
                ? '<span class="inline-flex items-center text-xs font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded-full"><i class="fa fa-circle text-[6px] mr-1"></i>未读</span>'
                : '<span class="inline-flex items-center text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full"><i class="fa fa-check text-[10px] mr-1"></i>已读</span>';

            // 未读通知显示不同的样式
            const itemClass = isUnread ? 'bg-blue-50 border-l-4 border-primary' : 'bg-white';

            div.className = `${itemClass} rounded-xl shadow-sm p-4 flex items-center hover:shadow-md transition-shadow cursor-pointer`;

            // 点击显示详情
            div.onclick = async () => {
                // 显示详情弹窗
                showNotificationPopup(notification);

                // 标记为已读
                if (notification.is_read === 0) {
                    try {
                        await fetch('/notifications/markAsRead', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ notification_id: notification.id })
                        });
                        // 更新顶部铃铛通知数字
                        updateNotificationBadge();
                        // 重新加载列表
                        const isUnreadTab = document.getElementById('tab-unread').classList.contains('bg-lightBlue');
                        loadNotificationsPC(isUnreadTab);
                    } catch (error) {
                        console.error('标记已读失败:', error);
                    }
                }
            };

            // 根据通知类型设置不同的图标和背景色
            const typeConfig = {
                1: { icon: 'fa-heart', color: 'from-pink-400 to-red-400', title: '点赞通知' },
                2: { icon: 'fa-comment', color: 'from-purple-400 to-pink-400', title: '评论通知' },
                3: { icon: 'fa-user-plus', color: 'from-blue-400 to-cyan-400', title: '关注通知' },
                4: { icon: 'fa-envelope', color: 'from-green-400 to-teal-400', title: '私信通知' },
                5: { icon: 'fa-bell', color: 'from-yellow-400 to-orange-400', title: '系统通知' }
            };

            const config = typeConfig[notification.type] || typeConfig[5];

            // 格式化时间
            const time = new Date(notification.create_time);
            const now = new Date();
            const diff = now - time;
            let timeText;

            if (diff < 60000) { // 1分钟内
                timeText = '刚刚';
            } else if (diff < 3600000) { // 1小时内
                timeText = Math.floor(diff / 60000) + '分钟前';
            } else if (diff < 86400000) { // 1天内
                timeText = Math.floor(diff / 3600000) + '小时前';
            } else {
                timeText = time.toLocaleDateString('zh-CN');
            }

            div.innerHTML = `
                <div class="w-12 h-12 rounded-full bg-gradient-to-br ${config.color} flex items-center justify-center text-white mr-3">
                    <i class="fa ${config.icon} text-xl"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium mb-1">${config.title}</div>
                    <div class="text-xs text-gray-500">${notification.content}</div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <div class="text-xs text-gray-400">${timeText}</div>
                    ${readStatusText}
                </div>
            `;

            return div;
        }

        // 页面加载完成后获取数据
        window.addEventListener('DOMContentLoaded', function() {
            if (window.currentUserInfo && window.currentUserInfo.id) {
                loadNotificationsPC(false);
            }
        });
    </script>

    <!-- 通知列表 -->
    <div id="notifications-content" class="space-y-3">
        <div class="text-center py-8 text-gray-500">
            <i class="fa fa-spinner fa-spin text-xl mb-2"></i>
            <p>加载中...</p>
        </div>
    </div>
</main>
{/block}

{block name="contentMobile"}
<!-- 移动端内容 -->
<div class="px-4 py-4">
    <!-- 页面标题 -->
    <h1 class="text-xl font-bold mb-4 flex items-center">
        <i class="fa fa-bell mr-2 text-primary"></i>
        通知中心
    </h1>

    <!-- 标签切换 -->
    <div class="flex gap-2 mb-4 bg-bg-card rounded-lg p-1 shadow-soft">
        <button id="tab-all-mobile" class="flex-1 py-2 px-4 rounded-lg bg-lightBlue text-primary font-medium transition-colors text-sm" onclick="switchTabMobile('all')">
            <i class="fa fa-bell mr-1"></i>全部
        </button>
        <button id="tab-unread-mobile" class="flex-1 py-2 px-4 rounded-lg text-text-secondary hover:bg-lightBlue hover:text-primary font-medium transition-colors text-sm" onclick="switchTabMobile('unread')">
            <i class="fa fa-envelope mr-1"></i>未读
        </button>
    </div>

    <!-- 通知列表 -->
    <div id="notifications-content-mobile" class="space-y-3">
        <div class="text-center py-8 text-gray-500">
            <i class="fa fa-spinner fa-spin text-xl mb-2"></i>
            <p>加载中...</p>
        </div>
    </div>
</div>

<script>
    // 移动端：获取当前用户信息
    window.currentUserInfo = <?php echo isset($isLogin) && $isLogin && $currentUser ? json_encode([
        'id' => $currentUser['id'] ?? '',
        'username' => $currentUser['username'] ?? '',
        'nickname' => $currentUser['nickname'] ?? '',
        'avatar' => $currentUser['avatar'] ?? '/static/images/default-avatar.png'
    ]) : 'null'; ?>;

    // 移动端：获取当前用户ID
    if (typeof window.NOTIFICATION_USER_ID === 'undefined') {
        if (window.currentUserInfo && window.currentUserInfo.id) {
            window.NOTIFICATION_USER_ID = parseInt(window.currentUserInfo.id);
        } else {
            window.NOTIFICATION_USER_ID = null;
        }
    }

    // 移动端：页面加载完成后获取数据
    window.addEventListener('DOMContentLoaded', function() {
        // 仅登录用户加载数据
        if (window.NOTIFICATION_USER_ID) {
            loadNotificationsMobile();
        } else {
            // 游客显示提示
            const container = document.getElementById('notifications-content-mobile');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fa fa-user-circle text-4xl mb-3"></i>
                        <p>登录后查看通知</p>
                        <a href="/login" class="inline-block mt-3 px-4 py-2 bg-primary text-white rounded-lg text-sm">立即登录</a>
                    </div>
                `;
            }
        }
    });

    // 移动端：切换标签
    function switchTabMobile(tabName) {
        // 重置所有标签样式
        document.getElementById('tab-all-mobile').classList.remove('bg-lightBlue', 'text-primary');
        document.getElementById('tab-all-mobile').classList.add('text-text-secondary', 'hover:bg-lightBlue', 'hover:text-primary');
        document.getElementById('tab-unread-mobile').classList.remove('bg-lightBlue', 'text-primary');
        document.getElementById('tab-unread-mobile').classList.add('text-text-secondary', 'hover:bg-lightBlue', 'hover:text-primary');

        // 设置选中标签样式
        if (tabName === 'all') {
            document.getElementById('tab-all-mobile').classList.remove('text-text-secondary', 'hover:bg-lightBlue', 'hover:text-primary');
            document.getElementById('tab-all-mobile').classList.add('bg-lightBlue', 'text-primary');
        } else if (tabName === 'unread') {
            document.getElementById('tab-unread-mobile').classList.remove('text-text-secondary', 'hover:bg-lightBlue', 'hover:text-primary');
            document.getElementById('tab-unread-mobile').classList.add('bg-lightBlue', 'text-primary');
        }

        // 重新加载通知
        loadNotificationsMobile(tabName === 'unread');
    }

    // 移动端：加载通知列表
    async function loadNotificationsMobile(unreadOnly = false) {
        const container = document.getElementById('notifications-content-mobile');
        if (!container) return;

        try {
            // 使用正确的API端点
            const response = await fetch('/notifications/getNotifications?unread_only=' + (unreadOnly ? 1 : 0), {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (result.code === 200) {
                const notifications = result.data.list;

                if (notifications.length > 0) {
                    // 渲染通知列表
                    container.innerHTML = '';
                    notifications.forEach(notification => {
                        const notificationElement = createNotificationElementMobile(notification);
                        container.appendChild(notificationElement);
                    });
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fa fa-bell-o text-4xl mb-3"></i>
                            <p>暂无通知</p>
                        </div>
                    `;
                }
            } else {
                throw new Error(result.msg || '获取通知失败');
            }
        } catch (error) {
            console.error('加载通知失败:', error);
            container.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <i class="fa fa-exclamation-circle text-xl mb-2"></i>
                    <p>加载失败，请稍后重试</p>
                </div>
            `;
        }
    }

    // 移动端：显示通知弹窗
    function showNotificationPopupMobile(notification) {
        // 创建弹窗
        const popup = document.createElement('div');
        popup.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm';

        // 格式化时间
        const time = new Date(notification.create_time);
        const timeText = time.toLocaleString('zh-CN');

        // 设置图标
        const typeConfig = {
            1: { icon: 'fa-heart', color: 'text-red-500', title: '点赞通知' },
            2: { icon: 'fa-comment', color: 'text-purple-500', title: '评论通知' },
            3: { icon: 'fa-user-plus', color: 'text-blue-500', title: '关注通知' },
            4: { icon: 'fa-envelope', color: 'text-green-500', title: '私信通知' },
            5: { icon: 'fa-bell', color: 'text-yellow-500', title: '系统通知' }
        };
        const config = typeConfig[notification.type] || typeConfig[5];

        popup.innerHTML = `
            <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <i class="fa ${config.icon} ${config.color} text-2xl mr-2"></i>
                        <h3 class="text-lg font-bold">${config.title}</h3>
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="text-gray-600 mb-4">${notification.content}</div>
                <div class="text-xs text-gray-400 text-right mb-4">${timeText}</div>
                ${notification.target_id && notification.target_type === 'moment' ? `
                    <a href="/moments/${notification.target_id}" class="block w-full text-center py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        查看动态
                    </a>
                ` : ''}
            </div>
        `;

        document.body.appendChild(popup);

        // 点击弹窗外部关闭
        popup.addEventListener('click', (e) => {
            if (e.target === popup) {
                popup.remove();
            }
        });
    }

    // 移动端：更新顶部通知徽章
    async function updateNotificationBadge() {
        try {
            const response = await fetch('/notifications/getBadge', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            if (result.code === 200 && result.data) {
                const count = result.data.count;

                // 更新PC端通知badge
                const pcBadge = document.getElementById('pc-notification-badge');
                if (pcBadge) {
                    if (count > 0) {
                        pcBadge.textContent = count > 99 ? '99+' : count;
                        pcBadge.classList.remove('hidden');
                    } else {
                        pcBadge.classList.add('hidden');
                    }
                }

                // 更新移动端顶部通知badge
                const mobileBadge = document.getElementById('mobile-notification-badge');
                if (mobileBadge) {
                    if (count > 0) {
                        mobileBadge.textContent = count > 99 ? '99+' : count;
                        mobileBadge.classList.remove('hidden');
                    } else {
                        mobileBadge.classList.add('hidden');
                    }
                }

                // 更新移动端底部导航"更多"的通知badge
                const footerBadge = document.getElementById('footer-notification-badge');
                if (footerBadge) {
                    if (count > 0) {
                        footerBadge.textContent = count > 99 ? '99+' : count;
                        footerBadge.classList.remove('hidden');
                    } else {
                        footerBadge.classList.add('hidden');
                    }
                }
            }
        } catch (error) {
            console.error('更新徽章失败:', error);
        }
    }

    // 移动端：创建通知元素
    function createNotificationElementMobile(notification) {
        const div = document.createElement('div');

        // 判断是否已读
        const isUnread = notification.is_read === 0;
        // 已读/未读标识
        const readStatusText = isUnread
            ? '<span class="inline-flex items-center text-xs font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded-full"><i class="fa fa-circle text-[5px] mr-1"></i>未读</span>'
            : '<span class="inline-flex items-center text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded-full"><i class="fa fa-check text-[8px] mr-1"></i>已读</span>';

        // 未读通知显示不同的样式
        const itemClass = isUnread ? 'bg-blue-50 border-l-4 border-primary' : 'bg-white';

        div.className = `${itemClass} rounded-xl shadow-sm p-4 flex items-center hover:shadow-md transition-shadow cursor-pointer`;

        // 根据通知类型设置图标和颜色
        const typeConfig = {
            1: { icon: 'fa-heart', color: 'from-red-400 to-pink-400', title: '点赞通知' },
            2: { icon: 'fa-comment', color: 'from-purple-400 to-blue-400', title: '评论通知' },
            3: { icon: 'fa-user-plus', color: 'from-blue-400 to-cyan-400', title: '关注通知' },
            4: { icon: 'fa-envelope', color: 'from-green-400 to-teal-400', title: '私信通知' },
            5: { icon: 'fa-bell', color: 'from-yellow-400 to-orange-400', title: '系统通知' }
        };

        const config = typeConfig[notification.type] || typeConfig[5];

        // 格式化时间
        const time = new Date(notification.create_time);
        const now = new Date();
        const diff = now - time;
        let timeText;

        if (diff < 60000) {
            timeText = '刚刚';
        } else if (diff < 3600000) {
            timeText = Math.floor(diff / 60000) + '分钟前';
        } else if (diff < 86400000) {
            timeText = Math.floor(diff / 3600000) + '小时前';
        } else {
            timeText = Math.floor(diff / 86400000) + '天前';
        }

        div.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-gradient-to-br ${config.color} flex items-center justify-center text-white mr-3 flex-shrink-0">
                <i class="fa ${config.icon}"></i>
            </div>
            <div class="flex-1 min-w-0">
                <div class="font-medium mb-1 text-sm">${config.title}</div>
                <div class="text-sm text-gray-600 truncate">${notification.content}</div>
            </div>
            <div class="flex flex-col items-end gap-0.5 ml-2 flex-shrink-0">
                <div class="text-xs text-gray-400">${timeText}</div>
                ${readStatusText}
            </div>
        `;

        // 点击显示详情
        div.onclick = async () => {
            // 显示详情弹窗
            showNotificationPopupMobile(notification);

            // 标记为已读
            if (notification.is_read === 0) {
                try {
                    await fetch('/notifications/markAsRead', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notification_id: notification.id })
                    });
                    // 更新顶部铃铛通知数字
                    updateNotificationBadge();
                    // 重新加载列表
                    const isUnreadTab = document.getElementById('tab-unread-mobile').classList.contains('bg-lightBlue');
                    loadNotificationsMobile(isUnreadTab);
                } catch (error) {
                    console.error('标记已读失败:', error);
                }
            }
        };

        return div;
    }
</script>
{/block}
