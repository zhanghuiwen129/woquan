{extend name="index/main-layout" /}

{block name="content"}
<style>
    .security-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .security-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .security-item:last-child {
        border-bottom: none;
    }

    .security-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4A90E2 0%, #3A7BC8 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        margin-right: 16px;
    }

    .security-info {
        flex: 1;
    }

    .security-title {
        font-weight: 600;
        color: #1D2129;
        margin-bottom: 4px;
    }

    .security-desc {
        font-size: 13px;
        color: #86909C;
    }

    .security-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-active {
        background: #E8FFEA;
        color: #00B42A;
    }

    .status-inactive {
        background: #FFF7E8;
        color: #FF7D00;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4A90E2 0%, #3A7BC8 100%);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    .btn-primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    .input-group {
        margin-bottom: 16px;
    }

    .input-label {
        display: block;
        font-size: 14px;
        color: #1D2129;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .input-field {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #E5E6EB;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .input-field:focus {
        outline: none;
        border-color: #4A90E2;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        font-size: 18px;
        font-weight: 600;
        color: #1D2129;
        margin-bottom: 20px;
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        margin-top: 24px;
    }

    .btn-secondary {
        background: #F2F3F5;
        color: #1D2129;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        flex: 1;
    }

    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        padding: 12px 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001;
        display: none;
    }

    .toast.show {
        display: block;
    }

    .toast-success {
        border-left: 4px solid #00B42A;
    }

    .toast-error {
        border-left: 4px solid #F53F3F;
    }
</style>

<div class="container mx-auto px-4 py-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">安全设置</h1>

        <!-- 账户安全 -->
        <div class="security-card">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">账户安全</h2>
            
            <div class="security-item">
                <div class="security-icon">
                    <i class="fa fa-lock"></i>
                </div>
                <div class="security-info">
                    <div class="security-title">登录密码</div>
                    <div class="security-desc">用于登录账户</div>
                </div>
                <span class="security-status status-active">已设置</span>
                <button class="btn-primary" onclick="showChangePasswordModal()">修改</button>
            </div>

            <div class="security-item">
                <div class="security-icon" style="background: linear-gradient(135deg, #FF7D00 0%, #FF9500 100%);">
                    <i class="fa fa-mobile"></i>
                </div>
                <div class="security-info">
                    <div class="security-title">手机绑定</div>
                    <div class="security-desc">用于接收验证码和安全提醒</div>
                </div>
                <span class="security-status status-inactive" id="phone-status">未绑定</span>
                <button class="btn-primary" id="phone-btn" onclick="showBindPhoneModal()">绑定</button>
            </div>

            <div class="security-item">
                <div class="security-icon" style="background: linear-gradient(135deg, #00B42A 0%, #00A854 100%);">
                    <i class="fa fa-envelope"></i>
                </div>
                <div class="security-info">
                    <div class="security-title">邮箱绑定</div>
                    <div class="security-desc">用于找回密码和安全通知</div>
                </div>
                <span class="security-status status-inactive" id="email-status">未绑定</span>
                <button class="btn-primary" id="email-btn" onclick="showBindEmailModal()">绑定</button>
            </div>
        </div>

        <!-- 登录安全 -->
        <div class="security-card">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">登录安全</h2>
            
            <div class="security-item">
                <div class="security-icon" style="background: linear-gradient(135deg, #F53F3F 0%, #D91D1D 100%);">
                    <i class="fa fa-shield"></i>
                </div>
                <div class="security-info">
                    <div class="security-title">双重验证</div>
                    <div class="security-desc">登录时需要额外的验证步骤</div>
                </div>
                <span class="security-status status-inactive" id="2fa-status">未开启</span>
                <button class="btn-primary" id="2fa-btn" onclick="toggle2FA()">开启</button>
            </div>

            <div class="security-item">
                <div class="security-icon" style="background: linear-gradient(135deg, #722ED1 0%, #531DAB 100%);">
                    <i class="fa fa-history"></i>
                </div>
                <div class="security-info">
                    <div class="security-title">登录历史</div>
                    <div class="security-desc">查看最近的登录记录</div>
                </div>
                <button class="btn-primary" onclick="location.href='/login-logs'">查看</button>
            </div>
        </div>

        <!-- 隐私设置 -->
        <div class="security-card">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">隐私设置</h2>
            
            <div class="security-item">
                <div class="security-icon" style="background: linear-gradient(135deg, #14C9C9 0%, #08979C 100%);">
                    <i class="fa fa-user-secret"></i>
                </div>
                <div class="security-info">
                    <div class="security-title">隐身模式</div>
                    <div class="security-desc">其他用户无法看到你的在线状态</div>
                </div>
                <span class="security-status status-inactive" id="stealth-status">未开启</span>
                <button class="btn-primary" id="stealth-btn" onclick="toggleStealth()">开启</button>
            </div>
        </div>
    </div>
</div>

<!-- 修改密码弹窗 -->
<div class="modal" id="change-password-modal">
    <div class="modal-content">
        <div class="modal-header">修改密码</div>
        <div class="input-group">
            <label class="input-label">当前密码</label>
            <input type="password" class="input-field" id="old-password" placeholder="请输入当前密码">
        </div>
        <div class="input-group">
            <label class="input-label">新密码</label>
            <input type="password" class="input-field" id="new-password" placeholder="请输入新密码（至少6位）">
        </div>
        <div class="input-group">
            <label class="input-label">确认新密码</label>
            <input type="password" class="input-field" id="confirm-password" placeholder="请再次输入新密码">
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('change-password-modal')">取消</button>
            <button class="btn-primary" onclick="changePassword()">确认修改</button>
        </div>
    </div>
</div>

<!-- 绑定手机弹窗 -->
<div class="modal" id="bind-phone-modal">
    <div class="modal-content">
        <div class="modal-header">绑定手机</div>
        <div class="input-group">
            <label class="input-label">手机号码</label>
            <input type="tel" class="input-field" id="phone-number" placeholder="请输入手机号码">
        </div>
        <div class="input-group">
            <label class="input-label">验证码</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" class="input-field" id="phone-code" placeholder="请输入验证码" style="flex: 1;">
                <button class="btn-primary" id="send-phone-code-btn" onclick="sendPhoneCode()">发送验证码</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('bind-phone-modal')">取消</button>
            <button class="btn-primary" onclick="bindPhone()">确认绑定</button>
        </div>
    </div>
</div>

<!-- 绑定邮箱弹窗 -->
<div class="modal" id="bind-email-modal">
    <div class="modal-content">
        <div class="modal-header">绑定邮箱</div>
        <div class="input-group">
            <label class="input-label">邮箱地址</label>
            <input type="email" class="input-field" id="email-address" placeholder="请输入邮箱地址">
        </div>
        <div class="input-group">
            <label class="input-label">验证码</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" class="input-field" id="email-code" placeholder="请输入验证码" style="flex: 1;">
                <button class="btn-primary" id="send-email-code-btn" onclick="sendEmailCode()">发送验证码</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('bind-email-modal')">取消</button>
            <button class="btn-primary" onclick="bindEmail()">确认绑定</button>
        </div>
    </div>
</div>

<!-- 提示框 -->
<div class="toast" id="toast"></div>

<script>
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast toast-' + type + ' show';
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function showModal(modalId) {
        document.getElementById(modalId).classList.add('show');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    function showChangePasswordModal() {
        showModal('change-password-modal');
    }

    function showBindPhoneModal() {
        showModal('bind-phone-modal');
    }

    function showBindEmailModal() {
        showModal('bind-email-modal');
    }

    async function changePassword() {
        const oldPassword = document.getElementById('old-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (!oldPassword || !newPassword || !confirmPassword) {
            showToast('请填写所有字段', 'error');
            return;
        }

        if (newPassword.length < 6) {
            showToast('新密码长度不能少于6位', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            showToast('两次输入的密码不一致', 'error');
            return;
        }

        try {
            const response = await fetch('/security/changePassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword
                })
            });

            const result = await response.json();

            if (result.code === 200) {
                showToast('密码修改成功');
                closeModal('change-password-modal');
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } else {
                showToast(result.msg || '修改失败', 'error');
            }
        } catch (error) {
            showToast('修改失败: ' + error.message, 'error');
        }
    }

    async function sendPhoneCode() {
        const phoneNumber = document.getElementById('phone-number').value;

        if (!phoneNumber) {
            showToast('请输入手机号码', 'error');
            return;
        }

        try {
            const response = await fetch('/user/sendSms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: phoneNumber,
                    type: 'bind'
                })
            });

            const result = await response.json();

            if (result.code === 200) {
                showToast('验证码已发送');
                const btn = document.getElementById('send-phone-code-btn');
                btn.disabled = true;
                let countdown = 60;
                const timer = setInterval(() => {
                    countdown--;
                    btn.textContent = countdown + '秒后重试';
                    if (countdown <= 0) {
                        clearInterval(timer);
                        btn.disabled = false;
                        btn.textContent = '发送验证码';
                    }
                }, 1000);
            } else {
                showToast(result.msg || '发送失败', 'error');
            }
        } catch (error) {
            showToast('发送失败: ' + error.message, 'error');
        }
    }

    async function bindPhone() {
        const phoneNumber = document.getElementById('phone-number').value;
        const code = document.getElementById('phone-code').value;

        if (!phoneNumber || !code) {
            showToast('请填写所有字段', 'error');
            return;
        }

        try {
            const response = await fetch('/user/bindPhone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: phoneNumber,
                    code: code
                })
            });

            const result = await response.json();

            if (result.code === 200) {
                showToast('手机绑定成功');
                closeModal('bind-phone-modal');
                document.getElementById('phone-status').textContent = '已绑定';
                document.getElementById('phone-status').className = 'security-status status-active';
                document.getElementById('phone-btn').textContent = '修改';
            } else {
                showToast(result.msg || '绑定失败', 'error');
            }
        } catch (error) {
            showToast('绑定失败: ' + error.message, 'error');
        }
    }

    async function sendEmailCode() {
        const email = document.getElementById('email-address').value;

        if (!email) {
            showToast('请输入邮箱地址', 'error');
            return;
        }

        try {
            const response = await fetch('/user/sendEmailCode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    type: 'bind'
                })
            });

            const result = await response.json();

            if (result.code === 200) {
                showToast('验证码已发送');
                const btn = document.getElementById('send-email-code-btn');
                btn.disabled = true;
                let countdown = 60;
                const timer = setInterval(() => {
                    countdown--;
                    btn.textContent = countdown + '秒后重试';
                    if (countdown <= 0) {
                        clearInterval(timer);
                        btn.disabled = false;
                        btn.textContent = '发送验证码';
                    }
                }, 1000);
            } else {
                showToast(result.msg || '发送失败', 'error');
            }
        } catch (error) {
            showToast('发送失败: ' + error.message, 'error');
        }
    }

    async function bindEmail() {
        const email = document.getElementById('email-address').value;
        const code = document.getElementById('email-code').value;

        if (!email || !code) {
            showToast('请填写所有字段', 'error');
            return;
        }

        try {
            const response = await fetch('/user/bindEmail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    code: code
                })
            });

            const result = await response.json();

            if (result.code === 200) {
                showToast('邮箱绑定成功');
                closeModal('bind-email-modal');
                document.getElementById('email-status').textContent = '已绑定';
                document.getElementById('email-status').className = 'security-status status-active';
                document.getElementById('email-btn').textContent = '修改';
            } else {
                showToast(result.msg || '绑定失败', 'error');
            }
        } catch (error) {
            showToast('绑定失败: ' + error.message, 'error');
        }
    }

    function toggle2FA() {
        showToast('双重验证功能开发中');
    }

    function toggleStealth() {
        showToast('隐身模式功能开发中');
    }
</script>
{/block}
