<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>找回密码 - LAN社交系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4A90E2',
                        darkPrimary: '#3A7BC8',
                        'bg-main': '#FFFFFF',
                        'bg-card': '#F7F8FA',
                        'text-primary': '#333647',
                        'text-secondary': '#6B6E7F',
                        'text-tertiary': '#9EA0AF',
                    }
                }
            }
        }
    </script>
    <style>
        .step-active {
            color: #4A90E2;
            border-color: #4A90E2;
        }
        .step-completed {
            color: #52C480;
            border-color: #52C480;
        }
    </style>
</head>
<body class="bg-bg-main text-text-primary min-h-screen">
    <!-- 顶部导航 -->
    <nav class="fixed top-0 left-0 right-0 h-16 bg-bg-main border-b border-gray-200 flex items-center justify-between px-4 lg:px-6 z-50">
        <div class="flex items-center gap-4">
            <a href="/" class="text-xl font-bold text-primary">
                <i class="fa fa-comments-o"></i> LAN
            </a>
        </div>
        <a href="/login" class="text-text-secondary hover:text-primary transition-colors text-sm">
            <i class="fa fa-arrow-left mr-1"></i>返回登录
        </a>
    </nav>

    <!-- 主内容区 -->
    <main class="pt-24 pb-12 px-4">
        <div class="max-w-md mx-auto">
            <!-- 进度指示器 -->
            <div class="flex items-center justify-center mb-8">
                <div class="flex items-center">
                    <div id="step1-indicator" class="flex items-center justify-center w-10 h-10 rounded-full border-2 border-primary text-primary font-bold step-active">1</div>
                    <div id="line1" class="w-16 h-0.5 bg-gray-300"></div>
                    <div id="step2-indicator" class="flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 text-gray-400 font-bold">2</div>
                    <div id="line2" class="w-16 h-0.5 bg-gray-300"></div>
                    <div id="step3-indicator" class="flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 text-gray-400 font-bold">3</div>
                </div>
            </div>

            <!-- 步骤1：验证手机号 -->
            <div id="step1" class="bg-bg-card rounded-xl p-6">
                <div class="text-center mb-6">
                    <i class="fa fa-mobile text-4xl text-primary mb-3"></i>
                    <h2 class="text-xl font-bold text-text-primary">找回密码</h2>
                    <p class="text-sm text-text-secondary mt-1">请输入您的手机号进行验证</p>
                </div>

                <form id="phone-form" onsubmit="verifyPhone(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-primary mb-2">手机号</label>
                        <input type="tel" id="phone" placeholder="请输入手机号" maxlength="11"
                               class="w-full px-4 py-3 bg-white rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               oninput="this.value = this.value.replace(/\D/g, '')">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-2">短信验证码</label>
                        <div class="flex gap-2">
                            <input type="text" id="sms-code" placeholder="请输入验证码" maxlength="6"
                                   class="flex-1 px-4 py-3 bg-white rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                   oninput="this.value = this.value.replace(/\D/g, '')">
                            <button type="button" id="send-btn" onclick="sendSMSCode()" 
                                    class="px-4 py-3 bg-primary text-white rounded-lg text-sm font-medium hover:bg-darkPrimary transition-colors whitespace-nowrap min-w-[120px]">
                                获取验证码
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded-lg font-medium hover:bg-darkPrimary transition-colors">
                        下一步
                    </button>
                </form>
            </div>

            <!-- 步骤2：设置新密码 -->
            <div id="step2" class="bg-bg-card rounded-xl p-6 hidden">
                <div class="text-center mb-6">
                    <i class="fa fa-lock text-4xl text-primary mb-3"></i>
                    <h2 class="text-xl font-bold text-text-primary">设置新密码</h2>
                    <p class="text-sm text-text-secondary mt-1">密码为6-16位字母数字组合</p>
                </div>

                <form id="password-form" onsubmit="resetPassword(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-primary mb-2">新密码</label>
                        <div class="relative">
                            <input type="password" id="new-password" placeholder="请输入新密码" maxlength="16"
                                   class="w-full px-4 py-3 bg-white rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent pr-12"
                                   oninput="checkPasswordStrength(this.value)">
                            <button type="button" onclick="togglePassword('new-password')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-text-secondary hover:text-primary">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                        <!-- 密码强度指示器 -->
                        <div class="mt-2 flex gap-1">
                            <div id="strength-1" class="h-1 flex-1 bg-gray-300 rounded"></div>
                            <div id="strength-2" class="h-1 flex-1 bg-gray-300 rounded"></div>
                            <div id="strength-3" class="h-1 flex-1 bg-gray-300 rounded"></div>
                        </div>
                        <p id="strength-text" class="text-xs text-text-secondary mt-1">密码强度：未输入</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-2">确认密码</label>
                        <div class="relative">
                            <input type="password" id="confirm-password" placeholder="请再次输入新密码" maxlength="16"
                                   class="w-full px-4 py-3 bg-white rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent pr-12">
                            <button type="button" onclick="togglePassword('confirm-password')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-text-secondary hover:text-primary">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded-lg font-medium hover:bg-darkPrimary transition-colors">
                        重置密码
                    </button>
                    <button type="button" onclick="goToStep(1)" class="w-full px-4 py-3 bg-bg-main text-text-primary rounded-lg font-medium hover:bg-gray-100 transition-colors mt-3">
                        上一步
                    </button>
                </form>
            </div>

            <!-- 步骤3：完成 -->
            <div id="step3" class="bg-bg-card rounded-xl p-6 hidden">
                <div class="text-center">
                    <div class="w-20 h-20 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fa fa-check text-4xl text-green-500"></i>
                    </div>
                    <h2 class="text-xl font-bold text-text-primary mb-2">密码重置成功</h2>
                    <p class="text-sm text-text-secondary mb-6">您的新密码已设置成功，请使用新密码登录</p>
                    
                    <button onclick="goToLogin()" class="w-full px-4 py-3 bg-primary text-white rounded-lg font-medium hover:bg-darkPrimary transition-colors">
                        立即登录
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 提示消息 -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 hidden">
        <span id="toast-message"></span>
    </div>

    <script>
        let currentStep = 1;
        let countdownTimer = null;
        let countdownSeconds = 60;
        let verifiedPhone = '';

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStepIndicator();
        });

        // 发送短信验证码
        async function sendSMSCode() {
            const phone = document.getElementById('phone').value.trim();
            
            if (!phone) {
                showToast('请输入手机号', 'error');
                return;
            }
            
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showToast('手机号格式不正确', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/sms/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone: phone,
                        type: 'forgot_password'
                    })
                });
                const data = await response.json();
                
                if (data.code === 200) {
                    showToast('验证码已发送');
                    startCountdown();
                } else {
                    showToast(data.msg || '发送失败', 'error');
                }
            } catch (error) {
                showToast('发送失败，请重试', 'error');
            }
        }

        // 开始倒计时
        function startCountdown() {
            const btn = document.getElementById('send-btn');
            countdownSeconds = 60;
            
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.textContent = `${countdownSeconds}s后重发`;
            
            countdownTimer = setInterval(() => {
                countdownSeconds--;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.textContent = '获取验证码';
                } else {
                    btn.textContent = `${countdownSeconds}s后重发`;
                }
            }, 1000);
        }

        // 验证手机号
        async function verifyPhone(event) {
            event.preventDefault();
            
            const phone = document.getElementById('phone').value.trim();
            const smsCode = document.getElementById('sms-code').value.trim();
            
            if (!phone) {
                showToast('请输入手机号', 'error');
                return;
            }
            
            if (!smsCode) {
                showToast('请输入验证码', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/user/verify-phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phone,
                        sms_code: smsCode,
                        type: 'forgot_password'
                    })
                });
                const data = await response.json();
                
                if (data.code === 200) {
                    verifiedPhone = phone;
                    showToast('验证成功');
                    goToStep(2);
                } else {
                    showToast(data.msg || '验证失败', 'error');
                }
            } catch (error) {
                showToast('验证失败，请重试', 'error');
            }
        }

        // 检查密码强度
        function checkPasswordStrength(password) {
            let strength = 0;
            const text = document.getElementById('strength-text');
            const bars = [
                document.getElementById('strength-1'),
                document.getElementById('strength-2'),
                document.getElementById('strength-3')
            ];
            
            // 重置样式
            bars.forEach(bar => {
                bar.className = 'h-1 flex-1 bg-gray-300 rounded';
            });
            
            if (password.length < 6) {
                text.textContent = '密码强度：未输入';
                text.className = 'text-xs text-text-secondary mt-1';
                return;
            }
            
            // 长度
            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            
            // 包含数字
            if (/\d/.test(password)) strength++;
            
            // 包含字母
            if (/[a-zA-Z]/.test(password)) strength++;
            
            // 包含特殊字符
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            // 更新显示
            if (strength <= 2) {
                bars[0].className = 'h-1 flex-1 bg-red-400 rounded';
                text.textContent = '密码强度：弱';
                text.className = 'text-xs text-red-400 mt-1';
            } else if (strength <= 4) {
                bars[0].className = 'h-1 flex-1 bg-yellow-400 rounded';
                bars[1].className = 'h-1 flex-1 bg-yellow-400 rounded';
                text.textContent = '密码强度：中';
                text.className = 'text-xs text-yellow-400 mt-1';
            } else {
                bars[0].className = 'h-1 flex-1 bg-green-500 rounded';
                bars[1].className = 'h-1 flex-1 bg-green-500 rounded';
                bars[2].className = 'h-1 flex-1 bg-green-500 rounded';
                text.textContent = '密码强度：强';
                text.className = 'text-xs text-green-500 mt-1';
            }
        }

        // 重置密码
        async function resetPassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();
            
            if (!newPassword) {
                showToast('请输入新密码', 'error');
                return;
            }
            
            if (newPassword.length < 6 || newPassword.length > 16) {
                showToast('密码长度应为6-16位', 'error');
                return;
            }
            
            if (!/[a-zA-Z]/.test(newPassword) || !/\d/.test(newPassword)) {
                showToast('密码需包含字母和数字', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('两次输入的密码不一致', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/user/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: verifiedPhone,
                        new_password: newPassword
                    })
                });
                const data = await response.json();
                
                if (data.code === 200) {
                    showToast('密码重置成功');
                    goToStep(3);
                } else {
                    showToast(data.msg || '重置失败', 'error');
                }
            } catch (error) {
                showToast('重置失败，请重试', 'error');
            }
        }

        // 切换步骤
        function goToStep(step) {
            currentStep = step;
            
            // 隐藏所有步骤
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            
            // 显示当前步骤
            document.getElementById('step' + step).classList.remove('hidden');
            
            // 更新进度指示器
            updateStepIndicator();
        }

        // 更新步骤指示器
        function updateStepIndicator() {
            const indicators = [
                document.getElementById('step1-indicator'),
                document.getElementById('step2-indicator'),
                document.getElementById('step3-indicator')
            ];
            const lines = [
                document.getElementById('line1'),
                document.getElementById('line2')
            ];
            
            // 重置所有指示器
            indicators.forEach((indicator, index) => {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full border-2 text-gray-400 font-bold';
                indicator.style.borderColor = '#d1d5db';
                indicator.style.color = '#9ca3af';
            });
            
            lines.forEach(line => {
                line.className = 'w-16 h-0.5 bg-gray-300';
            });
            
            // 更新已完成的步骤
            for (let i = 0; i < currentStep - 1; i++) {
                indicators[i].className = 'flex items-center justify-center w-10 h-10 rounded-full border-2 text-green-500 font-bold step-completed';
                indicators[i].style.borderColor = '#52C480';
                indicators[i].style.color = '#52C480';
                indicators[i].innerHTML = '<i class="fa fa-check"></i>';
                
                if (lines[i]) {
                    lines[i].className = 'w-16 h-0.5 bg-green-500';
                }
            }
            
            // 更新当前步骤
            if (currentStep <= 3) {
                indicators[currentStep - 1].className = 'flex items-center justify-center w-10 h-10 rounded-full border-2 text-primary font-bold step-active';
                indicators[currentStep - 1].style.borderColor = '#4A90E2';
                indicators[currentStep - 1].style.color = '#4A90E2';
                indicators[currentStep - 1].textContent = currentStep;
            }
        }

        // 切换密码显示
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fa fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fa fa-eye';
            }
        }

        // 前往登录
        function goToLogin() {
            window.location.href = '/login';
        }

        // 显示提示
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white`;
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
