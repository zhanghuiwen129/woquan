{extend name="admin/layout" /}

{block name="title"}<title>充值记录 - 后台管理系统</title>{/block}

{block name="content"}
<div class="mb-6">
    <h2 class="text-2xl font-semibold text-gray-800">充值记录</h2>
    <p class="text-gray-500 mt-1">管理用户的充值记录和订单状态</p>
</div>

<!-- 统计卡片 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="card stat-card p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">总充值金额</p>
                <p class="text-2xl font-bold text-gray-800 mt-1" id="totalAmount">¥0.00</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-yen-sign text-blue-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="card stat-card p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">待支付</p>
                <p class="text-2xl font-bold text-yellow-600 mt-1" id="pendingCount">0</p>
            </div>
            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-clock text-yellow-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="card stat-card p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">已支付</p>
                <p class="text-2xl font-bold text-green-600 mt-1" id="successCount">0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-check-circle text-green-600 text-xl"></i>
            </div>
        </div>
    </div>
    <div class="card stat-card p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">已取消</p>
                <p class="text-2xl font-bold text-red-600 mt-1" id="cancelCount">0</p>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-times-circle text-red-600 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- 搜索筛选 -->
<div class="card p-6 mb-6">
    <div class="flex flex-wrap items-center gap-4">
        <div class="flex-1 min-w-[200px]">
            <input type="text" id="keyword" placeholder="搜索用户名、订单号..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <select id="status" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="-1">全部状态</option>
            <option value="0">待支付</option>
            <option value="1">已支付</option>
            <option value="2">已取消</option>
        </select>
        <select id="dateRange" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">全部时间</option>
            <option value="today">今天</option>
            <option value="week">最近7天</option>
            <option value="month">最近30天</option>
        </select>
        <button onclick="search()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-search mr-2"></i>搜索
        </button>
        <button onclick="resetSearch()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            <i class="fas fa-redo mr-2"></i>重置
        </button>
    </div>
</div>

<!-- 数据表格 -->
<div class="card overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="bg-gray-50 border-b border-gray-200">
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">支付方式</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">流水号</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">支付时间</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-200">
                <!-- 数据将通过JS加载 -->
            </tbody>
        </table>
    </div>

    <!-- 分页 -->
    <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
        <div class="text-sm text-gray-500">
            共 <span id="totalCount">0</span> 条记录
        </div>
        <div class="flex items-center space-x-2" id="pagination">
            <!-- 分页按钮将通过JS生成 -->
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script>
let currentPage = 1;
let pageSize = 20;

// 加载数据
function loadData(page = 1) {
    currentPage = page;

    const keyword = document.getElementById('keyword').value;
    const status = document.getElementById('status').value;
    const dateRange = document.getElementById('dateRange').value;

    fetch(`/admin/assets/recharge?page=${page}&limit=${pageSize}&keyword=${encodeURIComponent(keyword)}&status=${status}&dateRange=${dateRange}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(result => {
            if (result.code === 200) {
                renderTable(result.data.list);
                renderPagination(result.data.total);
                updateStats(result.data.stats);
            } else {
                showCustomModal('加载失败', result.msg || '数据加载失败', 'error');
            }
        })
        .catch(error => {
            console.error('加载失败:', error);
            showCustomModal('加载失败', '网络错误，请稍后重试', 'error');
        });
}

// 渲染表格
function renderTable(data) {
    const tbody = document.getElementById('tableBody');

    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-500">暂无数据</td></tr>';
        return;
    }

    tbody.innerHTML = data.map(item => {
        const statusMap = {
            '0': '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded">待支付</span>',
            '1': '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">已支付</span>',
            '2': '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded">已取消</span>'
        };

        const statusKey = String(item.status);

        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.id}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-2">
                            <i class="fas fa-user text-gray-500 text-sm"></i>
                        </div>
                        <div class="text-sm text-gray-900">${item.username || item.nickname || '未知用户'}</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">¥${parseFloat(item.amount).toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.pay_type || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.transaction_id || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${statusMap[statusKey] || statusMap['0']}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.pay_time ? formatDate(item.pay_time) : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.create_time)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                    <button onclick="viewDetail(${item.id})" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${item.status == 0 ? `
                    <button onclick="confirmOrder(${item.id})" class="text-green-600 hover:text-green-800">
                        <i class="fas fa-check"></i>
                    </button>
                    <button onclick="cancelOrder(${item.id})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                    ` : ''}
                </td>
            </tr>
        `;
    }).join('');
}

// 渲染分页
function renderPagination(total) {
    const totalPages = Math.ceil(total / pageSize);
    const pagination = document.getElementById('pagination');
    document.getElementById('totalCount').textContent = total;

    let html = '';

    // 上一页
    html += `<button onclick="loadData(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
        <i class="fas fa-chevron-left"></i>
    </button>`;

    // 页码
    for (let i = 1; i <= totalPages && i <= 5; i++) {
        html += `<button onclick="loadData(${i})" class="px-3 py-1 border rounded ${currentPage === i ? 'bg-blue-600 text-white' : 'hover:bg-gray-50'}">${i}</button>`;
    }

    // 下一页
    html += `<button onclick="loadData(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''} class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
        <i class="fas fa-chevron-right"></i>
    </button>`;

    pagination.innerHTML = html;
}

// 更新统计数据
function updateStats(stats) {
    if (stats) {
        document.getElementById('totalAmount').textContent = `¥${parseFloat(stats.total_amount || 0).toFixed(2)}`;
        document.getElementById('pendingCount').textContent = stats.pending_count || 0;
        document.getElementById('successCount').textContent = stats.success_count || 0;
        document.getElementById('cancelCount').textContent = stats.cancel_count || 0;
    }
}

// 搜索
function search() {
    loadData(1);
}

// 重置搜索
function resetSearch() {
    document.getElementById('keyword').value = '';
    document.getElementById('status').value = '-1';
    document.getElementById('dateRange').value = '';
    loadData(1);
}

// 格式化日期
function formatDate(timestamp) {
    if (!timestamp) return '-';
    const date = new Date(timestamp * 1000);
    return date.toLocaleString('zh-CN');
}

// 查看详情
function viewDetail(id) {
    showCustomModal('订单详情', '功能开发中...', 'info');
}

// 确认订单
function confirmOrder(id) {
    showCustomModal('确认支付', '确认该订单已支付？', 'warning', function() {
        fetch(`/admin/assets/confirm-recharge`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(result => {
            if (result.code === 200) {
                showCustomModal('操作成功', '订单已确认支付', 'success');
                loadData(currentPage);
            } else {
                showCustomModal('操作失败', result.msg || '操作失败', 'error');
            }
        })
        .catch(error => {
            showCustomModal('操作失败', '网络错误，请稍后重试', 'error');
        });
    });
}

// 取消订单
function cancelOrder(id) {
    showCustomModal('取消订单', '确认取消该订单？', 'warning', function() {
        fetch(`/admin/assets/cancel-recharge`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(result => {
            if (result.code === 200) {
                showCustomModal('操作成功', '订单已取消', 'success');
                loadData(currentPage);
            } else {
                showCustomModal('操作失败', result.msg || '操作失败', 'error');
            }
        })
        .catch(error => {
            showCustomModal('操作失败', '网络错误，请稍后重试', 'error');
        });
    });
}

// 页面加载时获取数据
document.addEventListener('DOMContentLoaded', function() {
    loadData(1);
});
</script>
{/block}
